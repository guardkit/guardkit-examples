---
paths: **/alembic/**, **/migrations/**, **/alembic.ini
---

# Database Migration Patterns

## Alembic Setup

**Basic alembic configuration** (alembic.ini):

```ini
[alembic]
script_location = alembic
prepend_sys_path = .
sqlalchemy.url = driver://user:pass@localhost/dbname

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic
```

## Creating Migrations

### Auto-generate migration from model changes:

```bash
# Create new migration
alembic revision --autogenerate -m "Add users table"

# Review generated migration in alembic/versions/

# Apply migration
alembic upgrade head

# Rollback one version
alembic downgrade -1

# Show current version
alembic current

# Show migration history
alembic history
```

## Migration File Structure

```python
"""Add users table

Revision ID: abc123
Revises:
Create Date: 2024-01-01 12:00:00.000000

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision: str = 'abc123'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(), nullable=False),
        sa.Column('username', sa.String(), nullable=False),
        sa.Column('hashed_password', sa.String(), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    # ### end Alembic commands ###
```

## Manual Migration Operations

```python
def upgrade() -> None:
    # Add column
    op.add_column('users', sa.Column('is_active', sa.Boolean(), nullable=True))

    # Modify column
    op.alter_column('users', 'email',
                    existing_type=sa.String(length=100),
                    type_=sa.String(length=255),
                    existing_nullable=False)

    # Create index
    op.create_index('ix_users_username', 'users', ['username'], unique=True)

    # Add foreign key
    op.create_foreign_key(
        'fk_posts_author_id_users',
        'posts', 'users',
        ['author_id'], ['id'],
        ondelete='CASCADE'
    )

    # Execute raw SQL
    op.execute("UPDATE users SET is_active = true WHERE is_active IS NULL")

def downgrade() -> None:
    # Reverse operations in opposite order
    op.execute("UPDATE users SET is_active = NULL")
    op.drop_constraint('fk_posts_author_id_users', 'posts', type_='foreignkey')
    op.drop_index('ix_users_username', table_name='users')
    op.alter_column('users', 'email',
                    existing_type=sa.String(length=255),
                    type_=sa.String(length=100),
                    existing_nullable=False)
    op.drop_column('users', 'is_active')
```

## Best Practices

1. **Always review auto-generated migrations** before applying
2. **Test migrations on development database** first
3. **Write downgrade functions** for all migrations
4. **Use meaningful migration messages** describing the change
5. **Keep migrations small and focused** on single logical change
6. **Never edit applied migrations** - create new ones instead
7. **Add data migrations separately** from schema changes

## Data Migrations

```python
from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import table, column

def upgrade() -> None:
    # Create temporary table reference
    users = table('users',
        column('id', sa.Integer),
        column('is_active', sa.Boolean)
    )

    # Update existing data
    op.execute(
        users.update().values(is_active=True)
    )

def downgrade() -> None:
    users = table('users',
        column('id', sa.Integer),
        column('is_active', sa.Boolean)
    )

    op.execute(
        users.update().values(is_active=None)
    )
```
