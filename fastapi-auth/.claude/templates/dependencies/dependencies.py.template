"""
{{FeatureName}} Dependencies

This module defines FastAPI dependencies for {{feature_name}} routes.
Dependencies are used for request validation, authentication, and resource injection.
"""

from fastapi import Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession

from src.db.session import get_db
from src.{{FeatureName}} import crud
from src.{{FeatureName}}.models import {{EntityName}}


async def valid_{{entity_name}}_id(
    {{entity_name}}_id: int,
    db: AsyncSession = Depends(get_db)
) -> {{EntityName}}:
    """
    Dependency to validate {{entity_name}} ID exists.

    This dependency fetches the {{entity_name}} from database and raises
    404 if not found. Use this to avoid repetitive existence checks.

    Args:
        {{entity_name}}_id: ID of the {{entity_name}} from path parameter
        db: Database session (injected)

    Returns:
        {{EntityName}} object if found

    Raises:
        HTTPException: 404 if {{entity_name}} not found

    Example:
        ```python
        @router.get("/{{{entity_name}}_id}")
        async def get_{{entity_name}}(
            {{entity_name}}: {{EntityName}} = Depends(valid_{{entity_name}}_id)
        ):
            # {{entity_name}} is guaranteed to exist here
            return {{entity_name}}
        ```
    """
    {{entity_name}} = await crud.{{entity_name}}.get(db, id={{entity_name}}_id)
    if not {{entity_name}}:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"{{EntityName}} with id {{entity_name}}_id not found"
        )
    return {{entity_name}}


async def active_{{entity_name}}_required(
    {{entity_name}}: {{EntityName}} = Depends(valid_{{entity_name}}_id)
) -> {{EntityName}}:
    """
    Dependency to ensure {{entity_name}} is active.

    Chains with valid_{{entity_name}}_id to first validate existence,
    then check if {{entity_name}} is active.

    Args:
        {{entity_name}}: {{EntityName}} object (from valid_{{entity_name}}_id dependency)

    Returns:
        {{EntityName}} object if active

    Raises:
        HTTPException: 400 if {{entity_name}} is not active

    Example:
        ```python
        @router.put("/{{{entity_name}}_id}")
        async def update_{{entity_name}}(
            {{entity_name}}: {{EntityName}} = Depends(active_{{entity_name}}_required)
        ):
            # {{entity_name}} exists and is active
            return {{entity_name}}
        ```
    """
    if not {{entity_name}}.is_active:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"{{EntityName}} is not active"
        )
    return {{entity_name}}


async def unique_{{entity_name}}_name(
    {{entity_name}}_name: str,
    db: AsyncSession = Depends(get_db)
) -> str:
    """
    Dependency to ensure {{entity_name}} name is unique.

    Use this when creating new {{entity_name_plural}} or updating names
    to prevent duplicates.

    Args:
        {{entity_name}}_name: Name to check for uniqueness
        db: Database session (injected)

    Returns:
        The name if unique

    Raises:
        HTTPException: 400 if name already exists

    Example:
        ```python
        @router.post("/")
        async def create_{{entity_name}}(
            name: str = Depends(unique_{{entity_name}}_name),
            data: {{EntityName}}Create = ...
        ):
            # name is guaranteed to be unique
            return {{entity_name}}
        ```
    """
    existing = await crud.{{entity_name}}.get_by_name(db, name={{entity_name}}_name)
    if existing:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"{{EntityName}} with name '{{{entity_name}}_name}' already exists"
        )
    return {{entity_name}}_name
